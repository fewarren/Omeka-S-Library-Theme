<?php
/**
 * Safe Layout Template for Sufism Library Theme
 * This version handles missing plugins gracefully
 */

// Initialize basic helpers safely
$escape = $this->plugin('escapeHtml');
$translate = $this->plugin('translate');

$site = $this->vars()->site ?? null;
$siteTitle = $site ? $site->title() : 'Library';

$stylesheet = $this->themeSetting('stylesheet');
$this->htmlElement('html')->setAttribute('lang', $this->lang());
$this->headMeta()->setCharset('utf-8');
$this->headMeta()->appendName('viewport', 'width=device-width, initial-scale=1');
$this->headTitle($siteTitle)->setSeparator(' Â· ');
$this->headTitle()->append($this->setting('installation_title', 'Omeka S'));

// Load CSS files safely
$this->headLink()->appendStylesheet($this->assetUrl('css/library.css'));

if (isset($stylesheet)) {
    $this->headLink()->appendStylesheet($this->assetUrl("css/$stylesheet.css"));
} else {
    $this->headLink()->appendStylesheet($this->assetUrl('css/default.css'));
}

// FORCE LOAD SUFISM FEATURES CSS
$this->headLink()->appendStylesheet($this->assetUrl('css/sufism-features.css'));
$this->headLink()->prependStylesheet($this->assetUrl('css/cumulus.css'));
$this->headLink()->prependStylesheet($this->assetUrl('css/iconfonts.css', 'Omeka'));

// Load JavaScript files safely
$this->headScript()->prependFile($this->assetUrl('vendor/foundation/foundation.min.js'));
$this->headScript()->prependFile($this->assetUrl('js/global.js', 'Omeka'));
$this->headScript()->prependFile($this->assetUrl('vendor/jquery/jquery.min.js', 'Omeka'));
$this->headScript()->appendFile($this->assetUrl('js/cumulus.js'));
$this->headScript()->appendFile($this->assetUrl('js/sufism-menu.js'));

$this->trigger('view.layout');
$this->jsTranslate();

// Get user bar safely
$userBar = '';
try {
    $userBar = $this->userBar();
} catch (Exception $e) {
    // Ignore user bar errors
}

$navLayout = ($this->themeSetting('nav_layout')) ? $this->themeSetting('nav_layout') : 'dropdown';
$this->htmlElement('body')->appendAttribute('class', 'library-theme sufism-reoriented-style');
$this->htmlElement('body')->appendAttribute('class', $navLayout . '-menu');
if ($userBar) {
  $this->htmlElement('body')->appendAttribute('class', 'user-bar');
}

$banner = $this->themeSettingAssetUrl('banner');
$bannerPosition = $this->themeSetting('banner_position', 'center center');
$bannerHeight = $this->themeSetting('banner_height', '');
$bannerHeightMobile = $this->themeSetting('banner_height_mobile', '');
$bannerWidth = $this->themeSetting('banner_width') ? 'width-' . $this->themeSetting('banner_width') : 'width-full';
?>
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        
        <?php echo $this->headMeta(); ?>
        <?php echo $this->headTitle(); ?>
        <?php echo $this->headLink(); ?>
        <?php echo $this->headStyle(); ?>
        <?php echo $this->headScript(); ?>
        
        <style>
            .banner {
                height: <?php echo ($bannerHeight !== '') ? $bannerHeight: 'auto'  ?>;
                background-image: url(<?php echo $this->themeSettingAssetUrl('banner'); ?>);
                background-position: <?php echo $bannerPosition; ?>;
            }
        <?php if ($bannerHeightMobile !== ''): ?>
            @media screen and (max-width:640px) {
                .banner {
                    height: <?php echo $bannerHeightMobile; ?>;
                }
            }
        <?php endif; ?>
            
            /* Dynamic theme colors from settings */
            :root {
                --library-secondary-color: <?php echo $this->themeSetting('library_secondary_color', '#005599'); ?>;
                --library-primary-color: <?php echo $this->themeSetting('library_primary_color', '#003366'); ?>;
                --library-accent-color: <?php echo $this->themeSetting('library_accent_color', '#ff6b35'); ?>;
            }
        </style>
    </head>
    
    <body>
        <div class="off-canvas-wrapper">
            <div id="offCanvas" class="off-canvas position-left" data-off-canvas role="navigation" aria-label="<?php echo $translate('Mobile Navigation'); ?>">
                <?php if ($site): ?>
                <?php echo $site->publicNav()->menu()->setPartial('common/foundation-navigation.phtml')->renderPartialWithParams(['layout' => 'vertical']); ?>
                <?php endif; ?>
                <div id="search" role="search" aria-label="<?php echo $translate('Search'); ?>">
                    <?= $this->partial('common/search-form') ?>
                </div>
            </div>
            
            <div class="off-canvas-content" data-off-canvas-content>
                <a id="skipnav" href="#content"><?php echo $translate('Skip to main content'); ?></a>
                <?php echo $userBar; ?>
                
                <header id="navigation" role="banner">
                    <?php if ($navLayout == 'vertical'): ?>
                    <?php echo $this->partial('common/header-vertical'); ?>
                    <?php else: ?>
                    <?php echo $this->partial('common/header-dropdown'); ?>
                    <?php endif; ?>
                </header>
                
                <?php if ($banner && ($navLayout == 'dropdown')): ?>
                <div class="banner <?php echo $bannerWidth; ?>" role="img" aria-label="<?php echo $translate('Site Banner'); ?>">
                    <img src="<?php echo $this->themeSettingAssetUrl('banner'); ?>" alt="<?php echo $escape($siteTitle); ?> Banner" role="presentation">
                </div>
                <?php endif; ?>
                
                <main id="main-content" role="main" aria-label="<?php echo $translate('Main Content'); ?>">
                    <?php if ($banner && ($navLayout == 'vertical')): ?>
                    <div class="banner <?php echo $bannerWidth; ?>" role="img" aria-label="<?php echo $translate('Site Banner'); ?>">
                        <img src="<?php echo $this->themeSettingAssetUrl('banner'); ?>" alt="<?php echo $escape($siteTitle); ?> Banner" role="presentation">
                    </div>
                    <?php endif; ?>
                    <?php echo $this->content; ?>
                </main>
                
                <footer role="contentinfo" aria-label="<?php echo $translate('Site Footer'); ?>">
                    <?php if ($footerContent = $this->themeSetting('footer')): ?>
                    <?php echo $footerContent; ?>
                    <?php else: ?>
                        <p><?php echo $translate('Powered by Omeka S'); ?></p>
                    <?php endif; ?>
                </footer>
            </div>
        </div>
        
        <script>
          $(document).foundation();
        </script>
    </body>
</html>
